<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Basket Analysis</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }
    header {
      background: linear-gradient(90deg, #0d6efd, #0dcaf0);
      color: white;
      padding: 2rem 1rem;
      text-align: center;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    footer {
      margin-top: 2rem;
      padding: 1rem;
      text-align: center;
      background: #212529;
      color: #ccc;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1><i class="bi bi-cart4"></i> Market Basket Analysis</h1>
    <p class="lead">Upload your transaction dataset and discover product associations</p>
  </header>

  <div class="container my-5">
    <!-- Upload Card -->
    <div class="card p-4 mb-4">
      <h4><i class="bi bi-upload"></i> Upload Dataset</h4>
      <p class="text-muted">Upload a CSV file where each row represents a transaction and items are separated by commas.</p>
      <input type="file" id="fileInput" accept=".csv" class="form-control" />
    </div>

    <!-- Results -->
    <div id="results" style="display:none;">
      <!-- Frequent Itemsets -->
      <div class="card p-4 mb-4">
        <h4><i class="bi bi-diagram-3"></i> Frequent Itemsets</h4>
        <table class="table table-striped" id="itemsetTable">
          <thead>
            <tr>
              <th>Items</th>
              <th>Support</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Rules -->
      <div class="card p-4 mb-4">
        <h4><i class="bi bi-lightbulb"></i> Association Rules</h4>
        <table class="table table-striped" id="rulesTable">
          <thead>
            <tr>
              <th>Rule</th>
              <th>Confidence</th>
              <th>Lift</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Charts -->
      <div class="card p-4">
        <h4><i class="bi bi-bar-chart"></i> Top Products</h4>
        <canvas id="topProductsChart"></canvas>
      </div>
    </div>
  </div>

  <footer>
    <p>Developed by Eric Kumi | Market Basket Analysis Portfolio Project</p>
  </footer>

  <script>
    const minSupport = 0.2;   // 20%
    const minConfidence = 0.6; // 60%

    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        complete: function (results) {
          const data = results.data.filter(row => row.length > 0);
          processTransactions(data);
        }
      });
    });

    function processTransactions(data) {
      const transactions = data.map(row => row[0].split(",").map(item => item.trim()));
      const itemCounts = {};
      const totalTransactions = transactions.length;

      // Count single items
      transactions.forEach(t => {
        new Set(t).forEach(item => {
          itemCounts[item] = (itemCounts[item] || 0) + 1;
        });
      });

      // Frequent 1-itemsets
      const freqItemsets = Object.entries(itemCounts)
        .map(([item, count]) => ({ items: [item], support: count / totalTransactions }))
        .filter(d => d.support >= minSupport);

      // Simple rules (pairwise)
      const rules = [];
      for (let t of transactions) {
        const uniqueItems = [...new Set(t)];
        for (let i = 0; i < uniqueItems.length; i++) {
          for (let j = i+1; j < uniqueItems.length; j++) {
            const A = uniqueItems[i], B = uniqueItems[j];
            const supportAB = transactions.filter(x => x.includes(A) && x.includes(B)).length / totalTransactions;
            const supportA = itemCounts[A] / totalTransactions;
            const supportB = itemCounts[B] / totalTransactions;
            const confAB = supportAB / supportA;
            const confBA = supportAB / supportB;
            const lift = supportAB / (supportA * supportB);

            if (confAB >= minConfidence) rules.push({ rule: `${A} → ${B}`, conf: confAB, lift });
            if (confBA >= minConfidence) rules.push({ rule: `${B} → ${A}`, conf: confBA, lift });
          }
        }
      }

      displayResults(freqItemsets, rules, itemCounts, totalTransactions);
    }

    function displayResults(freqItemsets, rules, itemCounts, total) {
      document.getElementById("results").style.display = "block";

      // Frequent Itemsets
      const itemsetTable = document.querySelector("#itemsetTable tbody");
      itemsetTable.innerHTML = "";
      freqItemsets.forEach(d => {
        const row = `<tr><td>${d.items.join(", ")}</td><td>${(d.support*100).toFixed(2)}%</td></tr>`;
        itemsetTable.innerHTML += row;
      });

      // Rules
      const rulesTable = document.querySelector("#rulesTable tbody");
      rulesTable.innerHTML = "";
      rules.forEach(r => {
        const row = `<tr><td>${r.rule}</td><td>${(r.conf*100).toFixed(2)}%</td><td>${r.lift.toFixed(2)}</td></tr>`;
        rulesTable.innerHTML += row;
      });

      // Top Products Chart
      const sorted = Object.entries(itemCounts).sort((a,b) => b[1]-a[1]).slice(0,10);
      const labels = sorted.map(d => d[0]);
      const values = sorted.map(d => d[1]);

      new Chart(document.getElementById("topProductsChart"), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: "Frequency",
            data: values,
            backgroundColor: "rgba(13, 110, 253, 0.7)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  </script>
</body>
</html>
