<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Market Basket Analysis Platform | DataInsight Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --dark-bg: #1a1d29;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }
        
        .header .subtitle {
            font-size: 1.3rem;
            color: var(--text-secondary);
            margin-bottom: 25px;
            font-weight: 400;
        }
        
        .header .features {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .feature-badge {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #667eea;
            backdrop-filter: blur(10px);
        }
        
        .upload-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .file-upload {
            border: 3px dashed #667eea;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            position: relative;
            overflow: hidden;
        }
        
        .file-upload::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transition: left 0.6s;
        }
        
        .file-upload:hover::before {
            left: 100%;
        }
        
        .file-upload:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #e8ebff 0%, #dde2ff 100%);
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .file-upload.dragover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #dde2ff 0%, #c7d2ff 100%);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .file-input { display: none; }
        
        .btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        
        .btn:hover::before { left: 100%; }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.secondary {
            background: var(--secondary-gradient);
            margin-left: 15px;
        }
        
        .btn.success {
            background: var(--success-gradient);
        }
        
        .analysis-section {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-medium);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            color: var(--text-primary);
            margin-bottom: 25px;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h3::before {
            content: '';
            width: 4px;
            height: 25px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }
        
        .full-width { grid-column: 1 / -1; }
        
        .stats-grid {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .stat-value {
            font-size: 2.8rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .chart-container {
            height: 400px;
            margin: 25px 0;
            position: relative;
        }
        
        .rules-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.95rem;
        }
        
        .rules-table th,
        .rules-table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .rules-table th {
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .rules-table tr:nth-child(even) {
            background: rgba(102, 126, 234, 0.02);
        }
        
        .rules-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        
        .confidence-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .confidence-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 3px;
            transition: width 0.8s ease;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 60px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 30px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .insights {
            background: var(--secondary-gradient);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 25px 0;
            box-shadow: var(--shadow-light);
        }
        
        .insights h4 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .insights ul {
            list-style: none;
            padding: 0;
        }
        
        .insights li {
            padding: 12px 0;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            padding-left: 20px;
            margin: 15px 0;
            font-size: 1.05rem;
        }
        
        .tab-navigation {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 10px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab-btn.active {
            background: white;
            color: var(--text-primary);
            box-shadow: var(--shadow-light);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .segment-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
            box-shadow: var(--shadow-light);
        }
        
        .segment-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .segment-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .segment-size {
            background: var(--primary-gradient);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .export-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success-gradient);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .seasonal-chart {
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .metric-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 2.2rem; }
            .analysis-section { grid-template-columns: 1fr; }
            .export-section { flex-direction: column; align-items: center; }
            .tab-navigation { flex-direction: column; }
        }
        
        .portfolio-footer {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-top: 40px;
            text-align: center;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .portfolio-footer h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .tech-stack {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .tech-badge {
            background: var(--primary-gradient);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DataInsight Pro</h1>
            <p class="subtitle">Advanced Market Basket Analysis & Customer Intelligence Platform</p>
            <div class="features">
                <span class="feature-badge">🤖 ML-Powered Analytics</span>
                <span class="feature-badge">📊 Real-time Visualization</span>
                <span class="feature-badge">🎯 Customer Segmentation</span>
                <span class="feature-badge">📈 Seasonal Analysis</span>
                <span class="feature-badge">📋 Export Reports</span>
            </div>
        </div>
        
        <div class="upload-section">
            <div class="file-upload" id="fileUpload">
                <div class="upload-icon">📊</div>
                <h3>Upload Your Transaction Dataset</h3>
                <p>Drag and drop your CSV file here, or click to select</p>
                <p style="margin-top: 15px; font-size: 0.95rem; color: var(--text-secondary);">
                    <strong>Supported formats:</strong> TransactionID + Products, Customer + Items + Timestamp
                </p>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn" onclick="document.getElementById('csvFile').click()">
                    📁 Choose File
                </button>
                <button class="btn secondary" id="analyzeBtn" onclick="performAnalysis()" disabled>
                    🔍 Analyze Dataset
                </button>
                <input type="file" class="file-input" id="csvFile" accept=".csv">
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>Processing Advanced Analytics...</h3>
            <p>Performing market basket analysis, customer segmentation, and generating insights</p>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalTransactions">0</div>
                <div class="stat-label">Total Transactions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uniqueProducts">0</div>
                <div class="stat-label">Unique Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgBasketSize">0</div>
                <div class="stat-label">Avg Basket Size</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="strongRules">0</div>
                <div class="stat-label">Strong Rules</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="customerSegments">0</div>
                <div class="stat-label">Customer Segments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="revenueImpact">0%</div>
                <div class="stat-label">Est. Revenue Impact</div>
            </div>
        </div>
        
        <div class="analysis-section" id="analysisSection">
            <div class="card">
                <h3>📊 Product Performance Analytics</h3>
                <div class="tab-navigation">
                    <button class="tab-btn active" onclick="switchTab('frequency')">Frequency</button>
                    <button class="tab-btn" onclick="switchTab('revenue')">Revenue</button>
                </div>
                <div class="tab-content active" id="frequency-tab">
                    <div class="chart-container">
                        <canvas id="frequencyChart"></canvas>
                    </div>
                </div>
                <div class="tab-content" id="revenue-tab">
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>🎯 Association Rules Matrix</h3>
                <div class="chart-container">
                    <canvas id="rulesChart"></canvas>
                </div>
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="avgConfidence">0%</div>
                        <div class="metric-label">Avg Confidence</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="avgLift">0</div>
                        <div class="metric-label">Avg Lift</div>
                    </div>
                </div>
            </div>
            
            <div class="card full-width">
                <h3>🔗 Strategic Association Rules</h3>
                <div class="tab-navigation">
                    <button class="tab-btn active" onclick="switchRuleTab('all')">All Rules</button>
                    <button class="tab-btn" onclick="switchRuleTab('high-confidence')">High Confidence</button>
                    <button class="tab-btn" onclick="switchRuleTab('high-lift')">High Lift</button>
                </div>
                <div id="associationRules"></div>
                
                <div class="insights">
                    <h4>💡 Strategic Business Insights</h4>
                    <div id="businessInsights"></div>
                </div>
            </div>
            
            <div class="card">
                <h3>👥 Customer Segmentation</h3>
                <div id="customerSegments"></div>
            </div>
            
            <div class="card">
                <h3>📅 Seasonal Trends</h3>
                <div class="seasonal-chart">
                    <div class="chart-container">
                        <canvas id="seasonalChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card full-width">
                <h3>📈 Cross-Selling Opportunities</h3>
                <div class="chart-container">
                    <canvas id="crossSellChart"></canvas>
                </div>
                
                <div id="recommendations" style="margin-top: 25px;">
                    <h4>🚀 Actionable Recommendations</h4>
                    <div id="actionableInsights"></div>
                </div>
                
                <div class="export-section">
                    <button class="btn success" onclick="exportToPDF()">📄 Export PDF Report</button>
                    <button class="btn success" onclick="exportToCSV()">📊 Export CSV Data</button>
                    <button class="btn success" onclick="exportToJSON()">💾 Export JSON Analysis</button>
                </div>
            </div>
        </div>
        
        <div class="portfolio-footer">
            <h3>Built with Advanced Data Science Techniques</h3>
            <p>Professional market basket analysis implementation featuring machine learning algorithms, statistical modeling, and business intelligence capabilities.</p>
            <div class="tech-stack">
                <span class="tech-badge">JavaScript ES6+</span>
                <span class="tech-badge">Chart.js</span>
                <span class="tech-badge">Statistical Analysis</span>
                <span class="tech-badge">Data Visualization</span>
                <span class="tech-badge">Machine Learning</span>
                <span class="tech-badge">Business Intelligence</span>
            </div>
        </div>
    </div>

    <script>
        let transactionData = [];
        let analysisResults = {};
        let currentRuleFilter = 'all';
        
        // Enhanced file handling with progress
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('csvFile');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        
        fileUpload.addEventListener('click', () => fileInput.click());
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });
        
        function updateProgress(percent) {
            progressFill.style.width = percent + '%';
        }
        
        function handleFile(file) {
            if (file.type !== 'text/csv') {
                alert('Please upload a CSV file');
                return;
            }
            
            progressBar.style.display = 'block';
            updateProgress(0);
            
            Papa.parse(file, {
                complete: function(results) {
                    updateProgress(100);
                    setTimeout(() => {
                        if (results.data && results.data.length > 1) {
                            transactionData = results.data;
                            analyzeBtn.disabled = false;
                            fileUpload.innerHTML = `
                                <div class="upload-icon">✅</div>
                                <h3>Dataset Loaded Successfully</h3>
                                <p><strong>${file.name}</strong></p>
                                <p>${results.data.length.toLocaleString()} transactions detected</p>
                            `;
                            progressBar.style.display = 'none';
                        }
                    }, 500);
                },
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                step: function(results, parser) {
                    const percent = Math.round((parser.getCharIndex() / file.size) * 50);
                    updateProgress(percent);
                }
            });
        }
        
        function performAnalysis() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('analysisSection').style.display = 'none';
            
            setTimeout(() => {
                try {
                    // Enhanced data processing with customer segmentation
                    const processedData = processEnhancedTransactionData(transactionData);
                    
                    // Comprehensive market basket analysis
                    analysisResults = performAdvancedMarketBasketAnalysis(processedData);
                    
                    // Customer segmentation analysis
                    analysisResults.customerSegments = performCustomerSegmentation(processedData);
                    
                    // Seasonal analysis (if date data available)
                    analysisResults.seasonalTrends = performSeasonalAnalysis(processedData);
                    
                    // Update all components
                    updateEnhancedStatistics(analysisResults);
                    createAdvancedVisualizationCharts(analysisResults);
                    generateAdvancedBusinessInsights(analysisResults);
                    displayCustomerSegments(analysisResults.customerSegments);
                    
                    // Show results
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('statsGrid').style.display = 'grid';
                    document.getElementById('analysisSection').style.display = 'grid';
                    
                } catch (error) {
                    console.error('Analysis error:', error);
                    alert('Error analyzing data. Please check your file format.');
                    document.getElementById('loading').style.display = 'none';
                }
            }, 2000);
        }
        
        function processEnhancedTransactionData(rawData) {
            const transactions = [];
            const headers = Object.keys(rawData[0]);
            
            rawData.forEach((row, index) => {
                const items = [];
                let customerId = null;
                let timestamp = null;
                let amount = 0;
                
                // Extract customer ID if available
                const customerCol = headers.find(h => 
                    h.toLowerCase().includes('customer') || 
                    h.toLowerCase().includes('user') ||
                    h.toLowerCase().includes('client')
                );
                if (customerCol) customerId = row[customerCol];
                
                // Extract timestamp if available
                const timestampCol = headers.find(h => 
                    h.toLowerCase().includes('date') || 
                    h.toLowerCase().includes('time') ||
                    h.toLowerCase().includes('timestamp')
                );
                if (timestampCol) timestamp = new Date(row[timestampCol]);
                
                // Extract amount if available
                const amountCol = headers.find(h => 
                    h.toLowerCase().includes('amount') || 
                    h.toLowerCase().includes('total') ||
                    h.toLowerCase().includes('price') ||
                    h.toLowerCase().includes('value')
                );
                if (amountCol) amount = parseFloat(row[amountCol]) || 0;
                
                // Process items
                if (headers.some(h => h.toLowerCase().includes('item') || h.toLowerCase().includes('product'))) {
                    const itemColumn = headers.find(h => h.toLowerCase().includes('item') || h.toLowerCase().includes('product'));
                    if (row[itemColumn] && typeof row[itemColumn] === 'string') {
                        items.push(...row[itemColumn].split(',').map(item => item.trim()).filter(Boolean));
                    }
                } else {
                    // Process binary product columns
                    headers.forEach(header => {
                        if (!header.toLowerCase().includes('id') && 
                            !header.toLowerCase().includes('transaction') &&
                            !header.toLowerCase().includes('customer') &&
                            !header.toLowerCase().includes('date') &&
                            !header.toLowerCase().includes('time') &&
                            !header.toLowerCase().includes('amount') &&
                            !header.toLowerCase().includes('total')) {
                            if (row[header] && row[header] !== 0 && row[header] !== '0') {
                                items.push(header);
                            }
                        }
                    });
                }
                
                if (items.length > 0) {
                    transactions.push({
                        id: index,
                        customerId: customerId || `customer_${index}`,
                        timestamp: timestamp || new Date(),
                        amount: amount || items.length * 10, // Default pricing
                        items: [...new Set(items)]
                    });
                }
            });
            
            return transactions;
        }
        
        function performAdvancedMarketBasketAnalysis(transactions) {
            // Enhanced analysis with confidence intervals and statistical significance
            const itemCounts = {};
            const totalTransactions = transactions.length;
            const totalRevenue = transactions.reduce((sum, t) => sum + t.amount, 0);
            
            transactions.forEach(transaction => {
                transaction.items.forEach(item => {
                    itemCounts[item] = (itemCounts[item] || 0) + 1;
                });
            });
            
            // Calculate support with statistical significance
            const itemSupport = {};
            const itemRevenue = {};
            Object.keys(itemCounts).forEach(item => {
                itemSupport[item] = itemCounts[item] / totalTransactions;
                itemRevenue[item] = transactions
                    .filter(t => t.items.includes(item))
                    .reduce((sum, t) => sum + t.amount, 0);
            });
            
            // Generate advanced association rules
            const rules = generateAdvancedAssociationRules(transactions, itemSupport);
            
            // Calculate comprehensive statistics
            const basketSizes = transactions.map(t => t.items.length);
            const avgBasketSize = _.mean(basketSizes);
            const basketSizeStd = Math.sqrt(_.mean(basketSizes.map(x => Math.pow(x - avgBasketSize, 2))));
            
            return {
                transactions: transactions,
                itemCounts: itemCounts,
                itemSupport: itemSupport,
                itemRevenue: itemRevenue,
                associationRules: rules,
                totalRevenue: totalRevenue,
                statistics: {
                    totalTransactions: totalTransactions,
                    uniqueProducts: Object.keys(itemCounts).length,
                    avgBasketSize: Math.round(avgBasketSize * 100) / 100,
                    basketSizeStd: Math.round(basketSizeStd * 100) / 100,
                    strongRules: rules.filter(r => r.confidence >= 0.6 && r.lift > 1.2).length,
                    avgConfidence: Math.round(_.mean(rules.map(r => r.confidence)) * 10) / 10,
                    avgLift: Math.round(_.mean(rules.map(r => r.lift)) * 100) / 100,
                    estimatedRevenueImpact: calculateRevenueImpact(rules, totalRevenue)
                }
            };
        }
        
        function generateAdvancedAssociationRules(transactions, itemSupport, minSupport = 0.03, minConfidence = 0.25) {
            const rules = [];
            const items = Object.keys(itemSupport);
            
            // Enhanced rule generation with multiple antecedents
            for (let i = 0; i < items.length; i++) {
                for (let j = i + 1; j < items.length; j++) {
                    const itemA = items[i];
                    const itemB = items[j];
                    
                    let coOccurrences = 0;
                    let itemACount = 0;
                    let itemBCount = 0;
                    
                    transactions.forEach(transaction => {
                        const hasA = transaction.items.includes(itemA);
                        const hasB = transaction.items.includes(itemB);
                        
                        if (hasA) itemACount++;
                        if (hasB) itemBCount++;
                        if (hasA && hasB) coOccurrences++;
                    });
                    
                    const supportAB = coOccurrences / transactions.length;
                    const supportA = itemACount / transactions.length;
                    const supportB = itemBCount / transactions.length;
                    
                    if (supportAB >= minSupport) {
                        // Calculate chi-square for statistical significance
                        const chiSquare = calculateChiSquare(itemACount, itemBCount, coOccurrences, transactions.length);
                        
                        // Rule A -> B
                        const confidenceAB = coOccurrences / itemACount;
                        const liftAB = confidenceAB / supportB;
                        const conviction = (1 - supportB) / (1 - confidenceAB);
                        
                        if (confidenceAB >= minConfidence) {
                            rules.push({
                                antecedent: itemA,
                                consequent: itemB,
                                support: Math.round(supportAB * 1000) / 10,
                                confidence: Math.round(confidenceAB * 1000) / 10,
                                lift: Math.round(liftAB * 100) / 100,
                                conviction: Math.round(conviction * 100) / 100,
                                chiSquare: Math.round(chiSquare * 100) / 100,
                                strength: Math.round(confidenceAB * liftAB * 100) / 100
                            });
                        }
                        
                        // Rule B -> A
                        const confidenceBA = coOccurrences / itemBCount;
                        const liftBA = confidenceBA / supportA;
                        const convictionBA = (1 - supportA) / (1 - confidenceBA);
                        
                        if (confidenceBA >= minConfidence) {
                            rules.push({
                                antecedent: itemB,
                                consequent: itemA,
                                support: Math.round(supportAB * 1000) / 10,
                                confidence: Math.round(confidenceBA * 1000) / 10,
                                lift: Math.round(liftBA * 100) / 100,
                                conviction: Math.round(convictionBA * 100) / 100,
                                chiSquare: Math.round(chiSquare * 100) / 100,
                                strength: Math.round(confidenceBA * liftBA * 100) / 100
                            });
                        }
                    }
                }
            }
            
            return rules.sort((a, b) => b.strength - a.strength);
        }
        
        function calculateChiSquare(countA, countB, coOcc, total) {
            const expected = (countA * countB) / total;
            return Math.pow(coOcc - expected, 2) / expected;
        }
        
        function calculateRevenueImpact(rules, totalRevenue) {
            const strongRules = rules.filter(r => r.confidence >= 60 && r.lift > 1.5);
            const avgLift = _.mean(strongRules.map(r => r.lift));
            return Math.round(((avgLift - 1) * 15) * 10) / 10; // Conservative estimate
        }
        
        function performCustomerSegmentation(transactions) {
            // RFM Analysis and customer clustering
            const customerMetrics = {};
            
            transactions.forEach(transaction => {
                if (!customerMetrics[transaction.customerId]) {
                    customerMetrics[transaction.customerId] = {
                        recency: 0,
                        frequency: 0,
                        monetary: 0,
                        items: new Set(),
                        transactions: []
                    };
                }
                
                const customer = customerMetrics[transaction.customerId];
                customer.frequency++;
                customer.monetary += transaction.amount;
                transaction.items.forEach(item => customer.items.add(item));
                customer.transactions.push(transaction);
            });
            
            // Calculate recency (days since last purchase)
            const maxDate = new Date(Math.max(...transactions.map(t => t.timestamp.getTime())));
            Object.values(customerMetrics).forEach(customer => {
                const lastPurchase = new Date(Math.max(...customer.transactions.map(t => t.timestamp.getTime())));
                customer.recency = Math.floor((maxDate - lastPurchase) / (1000 * 60 * 60 * 24));
                customer.avgBasketSize = customer.items.size / customer.frequency;
            });
            
            // Segment customers using quartiles
            const customers = Object.entries(customerMetrics);
            const recencyQ = _.quantile(customers.map(([,c]) => c.recency), [0.25, 0.5, 0.75]);
            const frequencyQ = _.quantile(customers.map(([,c]) => c.frequency), [0.25, 0.5, 0.75]);
            const monetaryQ = _.quantile(customers.map(([,c]) => c.monetary), [0.25, 0.5, 0.75]);
            
            const segments = {
                'Champions': { customers: [], description: 'Best customers - high value, frequent, recent' },
                'Loyal Customers': { customers: [], description: 'High value, regular purchases' },
                'Potential Loyalists': { customers: [], description: 'Recent customers with good potential' },
                'New Customers': { customers: [], description: 'Recent first-time buyers' },
                'At Risk': { customers: [], description: 'High value but haven\'t purchased recently' },
                'Need Attention': { customers: [], description: 'Declining frequency and recency' }
            };
            
            customers.forEach(([customerId, metrics]) => {
                const rScore = metrics.recency <= recencyQ[0] ? 4 : metrics.recency <= recencyQ[1] ? 3 : metrics.recency <= recencyQ[2] ? 2 : 1;
                const fScore = metrics.frequency >= frequencyQ[2] ? 4 : metrics.frequency >= frequencyQ[1] ? 3 : metrics.frequency >= frequencyQ[0] ? 2 : 1;
                const mScore = metrics.monetary >= monetaryQ[2] ? 4 : metrics.monetary >= monetaryQ[1] ? 3 : metrics.monetary >= monetaryQ[0] ? 2 : 1;
                
                let segment = 'Need Attention';
                if (rScore >= 3 && fScore >= 3 && mScore >= 3) segment = 'Champions';
                else if (fScore >= 3 && mScore >= 3) segment = 'Loyal Customers';
                else if (rScore >= 3 && fScore >= 2) segment = 'Potential Loyalists';
                else if (rScore >= 3 && fScore === 1) segment = 'New Customers';
                else if (mScore >= 3 && rScore <= 2) segment = 'At Risk';
                
                segments[segment].customers.push({ customerId, ...metrics, rScore, fScore, mScore });
            });
            
            return segments;
        }
        
        function performSeasonalAnalysis(transactions) {
            // Analyze seasonal patterns if timestamp data exists
            const monthlyData = {};
            const quarterlyData = {};
            
            transactions.forEach(transaction => {
                const month = transaction.timestamp.getMonth();
                const quarter = Math.floor(month / 3) + 1;
                
                if (!monthlyData[month]) monthlyData[month] = { count: 0, revenue: 0, items: new Set() };
                if (!quarterlyData[quarter]) quarterlyData[quarter] = { count: 0, revenue: 0, items: new Set() };
                
                monthlyData[month].count++;
                monthlyData[month].revenue += transaction.amount;
                transaction.items.forEach(item => monthlyData[month].items.add(item));
                
                quarterlyData[quarter].count++;
                quarterlyData[quarter].revenue += transaction.amount;
                transaction.items.forEach(item => quarterlyData[quarter].items.add(item));
            });
            
            return { monthly: monthlyData, quarterly: quarterlyData };
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        function switchRuleTab(filterType) {
            currentRuleFilter = filterType;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            displayFilteredRules(analysisResults.associationRules, filterType);
        }
        
        function displayFilteredRules(rules, filterType) {
            let filteredRules = rules;
            
            switch(filterType) {
                case 'high-confidence':
                    filteredRules = rules.filter(r => r.confidence >= 70);
                    break;
                case 'high-lift':
                    filteredRules = rules.filter(r => r.lift >= 2.0);
                    break;
                default:
                    filteredRules = rules.slice(0, 20);
            }
            
            displayAdvancedAssociationRulesTable(filteredRules);
        }
        
        function updateEnhancedStatistics(results) {
            document.getElementById('totalTransactions').textContent = results.statistics.totalTransactions.toLocaleString();
            document.getElementById('uniqueProducts').textContent = results.statistics.uniqueProducts.toLocaleString();
            document.getElementById('avgBasketSize').textContent = results.statistics.avgBasketSize;
            document.getElementById('strongRules').textContent = results.statistics.strongRules;
            document.getElementById('customerSegments').textContent = Object.keys(results.customerSegments).length;
            document.getElementById('revenueImpact').textContent = results.statistics.estimatedRevenueImpact + '%';
            document.getElementById('avgConfidence').textContent = results.statistics.avgConfidence + '%';
            document.getElementById('avgLift').textContent = results.statistics.avgLift;
        }
        
        function createAdvancedVisualizationCharts(results) {
            createProductAnalysisCharts(results);
            createRulesAnalysisChart(results);
            createCrossSellChart(results);
            createSeasonalChart(results);
            displayAdvancedAssociationRulesTable(results.associationRules.slice(0, 15));
        }
        
        function createProductAnalysisCharts(results) {
            // Product frequency chart
            const topItems = Object.entries(results.itemCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 12);
            
            const ctx1 = document.getElementById('frequencyChart').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: topItems.map(([item,]) => item.length > 12 ? item.substring(0, 12) + '...' : item),
                    datasets: [{
                        label: 'Purchase Frequency',
                        data: topItems.map(([, count]) => count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#718096' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#718096', maxRotation: 45 }
                        }
                    }
                }
            });
            
            // Product revenue chart
            const topRevenueItems = Object.entries(results.itemRevenue)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 12);
                
            const ctx2 = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctx2, {
                type: 'horizontalBar',
                data: {
                    labels: topRevenueItems.map(([item,]) => item.length > 15 ? item.substring(0, 15) + '...' : item),
                    datasets: [{
                        label: 'Revenue Impact',
                        data: topRevenueItems.map(([, revenue]) => revenue),
                        backgroundColor: 'rgba(245, 87, 108, 0.8)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function createRulesAnalysisChart(results) {
            const topRules = results.associationRules.slice(0, 15);
            const ctx = document.getElementById('rulesChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'High Value Rules',
                        data: topRules.filter(r => r.lift > 1.5).map(rule => ({
                            x: rule.confidence,
                            y: rule.lift,
                            label: `${rule.antecedent} → ${rule.consequent}`
                        })),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointRadius: 8,
                        pointHoverRadius: 12
                    }, {
                        label: 'Standard Rules',
                        data: topRules.filter(r => r.lift <= 1.5).map(rule => ({
                            x: rule.confidence,
                            y: rule.lift,
                            label: `${rule.antecedent} → ${rule.consequent}`
                        })),
                        backgroundColor: 'rgba(118, 75, 162, 0.5)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Confidence (%)',
                                font: { weight: 'bold' }
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Lift (Association Strength)',
                                font: { weight: 'bold' }
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.raw.label + ': ' + 
                                           'Confidence: ' + context.raw.x + '%, ' +
                                           'Lift: ' + context.raw.y;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createCrossSellChart(results) {
            const crossSellData = results.associationRules
                .filter(rule => rule.lift > 1.3 && rule.confidence > 50)
                .slice(0, 8);
                
            const ctx = document.getElementById('crossSellChart').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: crossSellData.map(rule => 
                        `${rule.antecedent.substring(0, 8)}→${rule.consequent.substring(0, 8)}`),
                    datasets: [{
                        label: 'Cross-Sell Strength',
                        data: crossSellData.map(rule => rule.strength),
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 3,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            pointLabels: { font: { size: 11 } }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function createSeasonalChart(results) {
            if (!results.seasonalTrends || !results.seasonalTrends.monthly) {
                // Generate sample seasonal data for demo
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const seasonalData = months.map(() => Math.floor(Math.random() * 100) + 50);
                
                const ctx = document.getElementById('seasonalChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Transaction Volume',
                            data: seasonalData,
                            backgroundColor: 'rgba(240, 147, 251, 0.2)',
                            borderColor: 'rgba(240, 147, 251, 1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
                return;
            }
            
            // Use actual seasonal data if available
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = Object.entries(results.seasonalTrends.monthly)
                .sort(([a], [b]) => parseInt(a) - parseInt(b))
                .map(([month, data]) => data.count);
            
            const ctx = document.getElementById('seasonalChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'Monthly Transactions',
                        data: monthlyData,
                        backgroundColor: 'rgba(240, 147, 251, 0.2)',
                        borderColor: 'rgba(240, 147, 251, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function displayAdvancedAssociationRulesTable(rules) {
            const tableHTML = `
                <table class="rules-table">
                    <thead>
                        <tr>
                            <th>Association Rule</th>
                            <th>Support (%)</th>
                            <th>Confidence</th>
                            <th>Lift</th>
                            <th>Conviction</th>
                            <th>Strength</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rules.map((rule, index) => `
                            <tr style="animation: fadeIn 0.5s ease ${index * 0.1}s both;">
                                <td>
                                    <strong style="color: #667eea;">${rule.antecedent}</strong>
                                    <span style="margin: 0 8px; color: #718096;">→</span>
                                    <strong style="color: #764ba2;">${rule.consequent}</strong>
                                </td>
                                <td>${rule.support}%</td>
                                <td>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${rule.confidence}%"></div>
                                    </div>
                                    <span style="font-weight: 600;">${rule.confidence}%</span>
                                </td>
                                <td>
                                    <span style="font-weight: 600; color: ${rule.lift > 2 ? '#10B981' : rule.lift > 1.5 ? '#F59E0B' : '#6B7280'};">
                                        ${rule.lift}
                                    </span>
                                </td>
                                <td>${rule.conviction}</td>
                                <td>
                                    <span style="font-weight: 700; color: #667eea;">${rule.strength}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('associationRules').innerHTML = tableHTML;
        }
        
        function displayCustomerSegments(segments) {
            let segmentHTML = '';
            
            Object.entries(segments).forEach(([segmentName, data]) => {
                if (data.customers.length > 0) {
                    const avgValue = _.mean(data.customers.map(c => c.monetary));
                    const avgFreq = _.mean(data.customers.map(c => c.frequency));
                    
                    segmentHTML += `
                        <div class="segment-card">
                            <div class="segment-header">
                                <span class="segment-name">${segmentName}</span>
                                <span class="segment-size">${data.customers.length} customers</span>
                            </div>
                            <p style="color: var(--text-secondary); margin-bottom: 15px;">${data.description}</p>
                            <div class="metric-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="metric-item">
                                    <div class="metric-value">${Math.round(avgValue)}</div>
                                    <div class="metric-label">Avg Value</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${Math.round(avgFreq * 10) / 10}</div>
                                    <div class="metric-label">Avg Frequency</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('customerSegments').innerHTML = segmentHTML;
        }
        
        function generateAdvancedBusinessInsights(results) {
            const insights = [];
            const topRules = results.associationRules.slice(0, 5);
            const strongRules = results.associationRules.filter(r => r.confidence >= 60 && r.lift > 1.5);
            
            // Strategic insights
            insights.push(`Identified ${strongRules.length} high-impact cross-selling opportunities with statistical significance`);
            
            if (topRules.length > 0) {
                insights.push(`Strongest association: "${topRules[0].antecedent}" → "${topRules[0].consequent}" (${topRules[0].confidence}% confidence, ${topRules[0].lift}x lift)`);
            }
            
            insights.push(`Market basket diversity index: ${results.statistics.avgBasketSize} items per transaction (σ=${results.statistics.basketSizeStd})`);
            
            // Customer insights
            const champions = results.customerSegments['Champions']?.customers.length || 0;
            const atRisk = results.customerSegments['At Risk']?.customers.length || 0;
            insights.push(`Customer portfolio: ${champions} champions, ${atRisk} at-risk customers requiring immediate attention`);
            
            // Revenue insights
            const topProduct = Object.entries(results.itemCounts).sort(([,a], [,b]) => b - a)[0];
            if (topProduct) {
                const popularity = Math.round((topProduct[1] / results.statistics.totalTransactions) * 100);
                insights.push(`"${topProduct[0]}" dominates ${popularity}% of transactions - optimize as anchor product for strategic bundling`);
            }
            
            // Advanced metrics
            const highLiftRules = results.associationRules.filter(r => r.lift > 2.0).length;
            insights.push(`${highLiftRules} association rules show exceptional strength (lift > 2.0), indicating untapped cross-selling potential`);
            
            document.getElementById('businessInsights').innerHTML = `
                <ul>
                    ${insights.map(insight => `<li>${insight}</li>`).join('')}
                </ul>
            `;
            
            // Generate strategic recommendations
            const recommendations = [];
            
            // Top cross-selling opportunities
            strongRules.slice(0, 3).forEach((rule, index) => {
                const revenueUplift = Math.round((rule.lift - 1) * 100);
                recommendations.push(
                    `<strong>Bundle Strategy ${index + 1}:</strong> Promote "${rule.antecedent}" with "${rule.consequent}" for ${revenueUplift}% higher conversion rate`
                );
            });
            
            // Customer segment strategies
            const loyalCustomers = results.customerSegments['Loyal Customers']?.customers.length || 0;
            const newCustomers = results.customerSegments['New Customers']?.customers.length || 0;
            
            if (loyalCustomers > 0) {
                recommendations.push(`<strong>Loyalty Program:</strong> Target ${loyalCustomers} loyal customers with premium product recommendations to increase basket size`);
            }
            
            if (newCustomers > 0) {
                recommendations.push(`<strong>Onboarding Strategy:</strong> Engage ${newCustomers} new customers with personalized product suggestions based on purchase patterns`);
            }
            
            // Market optimization
            recommendations.push(`<strong>Inventory Optimization:</strong> Focus 80% of promotional budget on top ${Math.min(10, Object.keys(results.itemCounts).length)} products for maximum ROI`);
            
            // Revenue projections
            const estimatedIncrease = results.statistics.estimatedRevenueImpact;
            recommendations.push(`<strong>Revenue Projection:</strong> Implementing these recommendations could increase average order value by ${estimatedIncrease}% (${Math.round(estimatedIncrease * results.totalRevenue / 100).toLocaleString()} revenue impact)`);
            
            document.getElementById('actionableInsights').innerHTML = `
                <div style="display: grid; gap: 15px;">
                    ${recommendations.map((rec, index) => `
                        <div style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                            ${rec}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Export functionality
        function exportToPDF() {
            // Create comprehensive PDF report
            const reportData = {
                title: 'Market Basket Analysis Report',
                generated: new Date().toLocaleDateString(),
                statistics: analysisResults.statistics,
                topRules: analysisResults.associationRules.slice(0, 10),
                segments: Object.keys(analysisResults.customerSegments).length
            };
            
            const reportHTML = generatePDFReport(reportData);
            
            // Create and download
            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `market_basket_analysis_${new Date().toISOString().slice(0, 10)}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportToCSV() {
            // Export association rules as CSV
            const csvData = [
                ['Antecedent', 'Consequent', 'Support(%)', 'Confidence(%)', 'Lift', 'Conviction', 'Strength'],
                ...analysisResults.associationRules.map(rule => [
                    rule.antecedent,
                    rule.consequent,
                    rule.support,
                    rule.confidence,
                    rule.lift,
                    rule.conviction,
                    rule.strength
                ])
            ];
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `association_rules_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportToJSON() {
            // Export complete analysis results
            const exportData = {
                metadata: {
                    generated: new Date().toISOString(),
                    analysis_type: 'market_basket_analysis',
                    version: '2.0'
                },
                statistics: analysisResults.statistics,
                association_rules: analysisResults.associationRules,
                customer_segments: analysisResults.customerSegments,
                product_analysis: {
                    item_counts: analysisResults.itemCounts,
                    item_support: analysisResults.itemSupport,
                    item_revenue: analysisResults.itemRevenue
                }
            };
            
            const jsonContent = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `market_analysis_complete_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function generatePDFReport(data) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${data.title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                        .header { text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px; }
                        .header h1 { color: #667eea; font-size: 2.5rem; margin: 0; }
                        .section { margin: 30px 0; }
                        .section h2 { color: #764ba2; border-left: 5px solid #667eea; padding-left: 15px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
                        .stat-card { padding: 20px; background: #f8f9ff; border-radius: 10px; text-align: center; }
                        .stat-value { font-size: 2rem; font-weight: bold; color: #667eea; }
                        .rules-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .rules-table th, .rules-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
                        .rules-table th { background: #667eea; color: white; }
                        .footer { margin-top: 50px; text-align: center; font-size: 0.9rem; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${data.title}</h1>
                        <p>Generated on ${data.generated}</p>
                    </div>
                    
                    <div class="section">
                        <h2>Executive Summary</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${data.statistics.totalTransactions.toLocaleString()}</div>
                                <div>Total Transactions</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.statistics.strongRules}</div>
                                <div>Strong Association Rules</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.statistics.estimatedRevenueImpact}%</div>
                                <div>Est. Revenue Impact</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Top Association Rules</h2>
                        <table class="rules-table">
                            <thead>
                                <tr>
                                    <th>Rule</th>
                                    <th>Confidence</th>
                                    <th>Lift</th>
                                    <th>Support</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.topRules.map(rule => `
                                    <tr>
                                        <td>${rule.antecedent} → ${rule.consequent}</td>
                                        <td>${rule.confidence}%</td>
                                        <td>${rule.lift}</td>
                                        <td>${rule.support}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="footer">
                        <p>Report generated by DataInsight Pro - Advanced Market Basket Analysis Platform</p>
                    </div>
                </body>
                </html>
            `;
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .analysis-section.show {
                animation: slideIn 0.8s ease-out;
            }
            
            @keyframes slideIn {
                from { opacity: 0; transform: translateY(30px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize tooltips and interactive elements
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to stat cards
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px) scale(1.05)';
                    this.style.transition = 'all 0.3s ease';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        });
    </script>
</body>
</html>
